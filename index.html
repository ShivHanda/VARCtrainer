<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VARC Trainer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@300;400;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8f9fa; }
        .font-serif { font-family: 'Merriweather', serif; }
        .rsvp-highlight { color: #dc2626; font-weight: bold; }
    </style>
</head>
<body class="p-4 md:p-8 max-w-4xl mx-auto">

    <div class="mb-8 flex justify-between items-end border-b pb-4">
        <div>
            <h1 class="text-3xl font-bold tracking-tight text-gray-900">VARC Trainer</h1>
            <p id="meta-info" class="text-sm text-gray-500 mt-1">Status: Initializing...</p>
        </div>
        <button onclick="location.reload()" class="text-sm bg-gray-200 px-3 py-1 rounded hover:bg-gray-300">Refresh</button>
    </div>

    <div id="loader" class="text-center py-20">
        <div class="text-2xl font-bold text-gray-400 animate-pulse">Loading Content...</div>
        <p class="text-xs text-gray-400 mt-2">Fetching data.json</p>
    </div>

    <div id="error-box" class="hidden bg-red-50 border border-red-200 text-red-800 p-6 rounded-lg text-center">
        <h3 class="font-bold text-lg">Something went wrong</h3>
        <p id="error-msg" class="mt-2 text-sm"></p>
    </div>

    <div id="app-content" class="hidden">
        <div id="view-dashboard">
            <h2 id="essay-title" class="text-2xl font-serif font-bold mb-6 text-gray-800">Title Here</h2>
            <div id="passages-grid" class="grid gap-4"></div>
        </div>

        <div id="view-reader" class="hidden">
            <button onclick="showDashboard()" class="mb-4 text-sm text-gray-500 hover:text-black">&larr; Back</button>
            
            <div class="sticky top-4 bg-white z-10 p-2 shadow rounded-lg border flex gap-2 justify-between items-center mb-6">
                <div class="flex gap-2">
                    <button onclick="setMode('normal')" class="px-3 py-1 text-sm bg-black text-white rounded">Read</button>
                    <button onclick="setMode('rsvp')" class="px-3 py-1 text-sm bg-gray-200 rounded">Speed</button>
                </div>
                <div id="rsvp-controls" class="hidden items-center gap-2">
                    <input type="range" min="200" max="600" step="50" value="300" id="wpm-slider" class="w-24">
                    <span id="wpm-val" class="text-xs font-mono">300</span>
                    <button onclick="toggleRSVP()" id="rsvp-btn" class="text-xs bg-red-600 text-white px-2 py-1 rounded">START</button>
                </div>
            </div>

            <div id="reader-area" class="bg-white p-6 md:p-10 rounded-xl shadow-sm border min-h-[300px] font-serif text-lg leading-relaxed text-gray-800">
                </div>

            <button onclick="startQuiz()" class="w-full mt-8 bg-indigo-600 text-white py-3 rounded-lg font-bold hover:bg-indigo-700">Take Quiz</button>
        </div>

        <div id="view-quiz" class="hidden">
            <h2 class="text-xl font-bold mb-6">Comprehension Check</h2>
            <div id="quiz-area" class="space-y-6"></div>
            <button onclick="showDashboard()" class="mt-8 text-gray-500 underline">Back to Home</button>
        </div>
    </div>

    <script>
        let data = null;
        let currentIdx = 0;
        let rsvpInterval, rsvpRunning = false, words = [], wordIdx = 0;

        // Force Cache Busting
        fetch('data.json?t=' + Date.now())
            .then(res => {
                if (!res.ok) throw new Error(`HTTP Error: ${res.status}`);
                return res.json();
            })
            .then(json => {
                data = json;
                if (!data.passages || data.passages.length === 0) throw new Error("JSON file is empty or has no passages.");
                initApp();
            })
            .catch(err => {
                document.getElementById('loader').classList.add('hidden');
                document.getElementById('error-box').classList.remove('hidden');
                document.getElementById('error-msg').innerText = err.message + " (Check GitHub Actions logs)";
            });

        function initApp() {
            document.getElementById('loader').classList.add('hidden');
            document.getElementById('app-content').classList.remove('hidden');
            
            document.getElementById('meta-info').innerText = `Source: ${data.metadata.source}`;
            document.getElementById('essay-title').innerText = data.metadata.title;

            const grid = document.getElementById('passages-grid');
            grid.innerHTML = '';
            
            data.passages.forEach((p, i) => {
                const card = document.createElement('div');
                card.className = "bg-white p-4 rounded-lg border hover:shadow-md cursor-pointer transition";
                card.onclick = () => loadPassage(i);
                card.innerHTML = `
                    <div class="text-xs font-bold text-gray-400 uppercase">Passage ${i+1}</div>
                    <div class="mt-2 text-gray-600 line-clamp-2 font-serif">${p.text.substring(0, 100)}...</div>
                    <div class="mt-4 text-indigo-600 text-sm font-bold">Read Now &rarr;</div>
                `;
                grid.appendChild(card);
            });
        }

        function loadPassage(idx) {
            currentIdx = idx;
            document.getElementById('view-dashboard').classList.add('hidden');
            document.getElementById('view-reader').classList.remove('hidden');
            setMode('normal');
        }

        function showDashboard() {
            stopRSVP();
            document.getElementById('view-reader').classList.add('hidden');
            document.getElementById('view-quiz').classList.add('hidden');
            document.getElementById('view-dashboard').classList.remove('hidden');
        }

        function setMode(mode) {
            stopRSVP();
            const area = document.getElementById('reader-area');
            const txt = data.passages[currentIdx].text;
            
            if (mode === 'normal') {
                document.getElementById('rsvp-controls').classList.add('hidden');
                area.innerHTML = txt.split('\n\n').map(p => `<p class="mb-4">${p}</p>`).join('');
            } else {
                document.getElementById('rsvp-controls').classList.remove('hidden');
                area.innerHTML = '<div id="rsvp-word" class="text-5xl font-bold text-center py-20">Ready?</div>';
                words = txt.split(/\s+/);
                wordIdx = 0;
            }
        }

        function toggleRSVP() {
            if (rsvpRunning) stopRSVP();
            else {
                rsvpRunning = true;
                const wpm = document.getElementById('wpm-slider').value;
                document.getElementById('rsvp-btn').innerText = "STOP";
                rsvpInterval = setInterval(() => {
                    if (wordIdx >= words.length) { stopRSVP(); return; }
                    document.getElementById('rsvp-word').innerText = words[wordIdx++];
                }, 60000 / wpm);
            }
        }

        function stopRSVP() {
            rsvpRunning = false;
            clearInterval(rsvpInterval);
            if(document.getElementById('rsvp-btn')) document.getElementById('rsvp-btn').innerText = "START";
        }

        function startQuiz() {
            document.getElementById('view-reader').classList.add('hidden');
            document.getElementById('view-quiz').classList.remove('hidden');
            const qArea = document.getElementById('quiz-area');
            qArea.innerHTML = '';
            
            const qs = data.passages[currentIdx].questions;
            if(!qs || qs.length === 0) {
                qArea.innerHTML = "<div>No questions available.</div>";
                return;
            }

            qs.forEach((q, i) => {
                const div = document.createElement('div');
                div.className = "bg-white p-6 rounded border";
                div.innerHTML = `
                    <p class="font-bold mb-4">${i+1}. ${q.question}</p>
                    <div class="space-y-2">
                        ${q.options.map((opt, oi) => `
                            <button onclick="check(this, ${i}, ${oi})" class="block w-full text-left p-2 border rounded hover:bg-gray-50">${opt}</button>
                        `).join('')}
                    </div>
                    <div id="fb-${i}" class="mt-4 text-sm hidden p-2 rounded"></div>
                `;
                qArea.appendChild(div);
            });
        }

        function check(btn, qIdx, optIdx) {
            const q = data.passages[currentIdx].questions[qIdx];
            const fb = document.getElementById(`fb-${qIdx}`);
            fb.classList.remove('hidden');
            
            if (optIdx === q.correct_index) {
                fb.className = "mt-4 text-sm p-2 rounded bg-green-100 text-green-800";
                fb.innerText = "Correct! " + q.explanation;
            } else {
                fb.className = "mt-4 text-sm p-2 rounded bg-red-100 text-red-800";
                fb.innerText = "Wrong. " + q.explanation;
            }
        }
        
        document.getElementById('wpm-slider').oninput = function() {
            document.getElementById('wpm-val').innerText = this.value;
        }
    </script>
</body>
</html>
